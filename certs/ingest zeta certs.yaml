name: ingest zeta certs
platform: node
blocks:
  - action: system/IBM/Concert/Certificates/List All Certificates Associated With
      an Environment
    name: listCerts
    inputs:
      - name: authKey
        value: '"ibmconcert/concert"'
      - name: filter
        value: '"environment_id:zeta"'
  - action: comment
    value: "iterate through list of certificates, creating an array of serial numbers"
  - action: foreach
    name: ForEach_cert
    list: $listCerts.result.certificates
    blocks:
      - action: system/Common/Array/Array Push
        name: ArrayPush_1
        inputs:
          - name: array
            value: $certIds
          - name: item
            value: $ForEach_cert.item.serial_number
      - action: assign
        name: Assign_2
        variable: $accessPoints
        value: "[]"
        skipped: true
      - action: comment
        value: get all the access points for a cert
      - action: foreach
        name: ForEach_access_points
        list: $ForEach_cert.item.access_points
        blocks:
          - name: Function_1
            function: $accessPointsIds.push($ForEach_access_points.item.id);
            skipped: true
          - action: system/Common/Array/Array Push
            name: ArrayPush_3
            inputs:
              - name: array
                value: $accessPointsIds
              - name: item
                value: $ForEach_access_points.item.id
      - action: assign
        name: Assign_5
        variable: $accessPoints
        value: "{\"access_points_ids\": $accessPointsIds, \"serial_number\": $ForEach_cert.item.serial_number\
          \ }"
        skipped: true
      - action: system/Common/Array/Array Push
        name: ArrayPush_5
        inputs:
          - name: array
            value: $accessPoints
          - name: item
            value: "{\"access_points_ids\": $accessPointsIds, \"serial_number\": $ForEach_cert.item.serial_number\
              \ }"
  - action: system/Common/Array/Array Push
    name: ArrayPush_4
    inputs:
      - name: array
        value: $accessPoints
      - name: item
        value: "{\"access_points_ids\": $accessPointsIds, \"serial_number\": $ForEach_cert.item.serial_number\
          \ }"
    skipped: true
  - action: system/Common/Array/Array Push
    name: ArrayPush_2
    inputs:
      - name: array
        value: $certsToDelete
      - name: item
        value: "{\"certificates\": $certIds}"
    skipped: true
  - action: assign
    name: Assign_3
    variable: $certsToDelete.certificates
    value: $certIds
  - action: assign
    name: Assign_4
    variable: $certsToDelete.access_points
    value: $accessPoints
  - action: assign
    name: Assign_1
    variable: $result
    value: $certsToDelete
variables:
  - name: result
    required: false
    isInput: false
    isOutput: true
    level: INTERMEDIATE
    type:
      type: any
    value: '""'
  - name: certData
    required: false
    isInput: false
    isOutput: false
    level: INTERMEDIATE
    type:
      type: object
    value: "{ \n\"components\": [\n\n  {\n    \"type\": \"certificate\",\n    \"ref\"\
      : \"certificate:19641002000006\",\n    \"serial_number\": \"19641002000006\"\
      ,\n    \"properties\": [\n      {\n        \"name\": \"subject\",\n        \"\
      value\": \"CN=guest-ca-tor-1-ww.ca-tor.qq.appdomain.cloud\"\n      },\n    \
      \  {\n        \"name\": \"issuer\",\n        \"value\": \"CN=A11,O=Test,C=AB\"\
      \n      },\n      {\n        \"name\": \"validity_start_date\",\n        \"\
      value\": \"2024-06-13 09:51:22 +0000 UTC\"\n      },\n      {\n        \"name\"\
      : \"validity_end_date\",\n        \"value\": \"2025-08-01 09:51:22 +0000 UTC\"\
      \n      },\n      {\n        \"name\": \"certificate_type\",\n        \"value\"\
      : \"pfx\"\n      },\n      {\n        \"name\": \"dns_names\",\n        \"value\"\
      : \"*.guest-ca-tor-1-ww.ca-tor.qq.appdomain.cloud\"\n      },\n      {\n   \
      \     \"name\": \"owner\",\n        \"value\": \"xyzgTp@domain.com\"\n     \
      \ },\n      {\n        \"name\": \"namespace\",\n        \"value\": \"openshift-config\"\
      \n      },\n      {\n        \"name\": \"metadata\",\n        \"value\": \"\
      {\\\"certificate_host\\\": \\\"\\\", \\\"service_info\\\": \\\"289****\\\",\
      \ \\\"dn\\\": \\\"\\\\\\\\VED\\\\\\\\Policy\\\\\\\\Aperture\\\\\\\\1CMB-CESD-IT\\\
      \\\\\\AI\\\\\\\\Non-******************************************\\\", \\\"senior_manager_contact\\\
      \": \\\"mDkfg1ufap@domain.com\\\"}\"\n      }\n    ],\n    \"access_points\"\
      : [\n      {\n        \"name\": \"foo\",\n        \"is_public\": \"false\",\n\
      \        \"url\": \"http://foo.com\"\n      },\n      {\n        \"name\": \"\
      bar\",\n        \"is_public\": \"false\",\n        \"url\": \"http://bar.com\"\
      \n      }\n    ]\n  },\n    {\n    \"type\": \"certificate\",\n    \"ref\":\
      \ \"certificate:19641002000007\",\n    \"serial_number\": \"19641002000007\"\
      ,\n    \"properties\": [\n      {\n        \"name\": \"subject\",\n        \"\
      value\": \"CN=guest-ca-tor-1-ww.ca-tor.qq.appdomain.cloud\"\n      },\n    \
      \  {\n        \"name\": \"issuer\",\n        \"value\": \"CN=A11,O=Test,C=AB\"\
      \n      },\n      {\n        \"name\": \"validity_start_date\",\n        \"\
      value\": \"2024-06-13 09:51:22 +0000 UTC\"\n      },\n      {\n        \"name\"\
      : \"validity_end_date\",\n        \"value\": \"2026-10-31 09:51:22 +0000 UTC\"\
      \n      },\n      {\n        \"name\": \"certificate_type\",\n        \"value\"\
      : \"pfx\"\n      },\n      {\n        \"name\": \"dns_names\",\n        \"value\"\
      : \"*.guest-ca-tor-1-ww.ca-tor.qq.appdomain.cloud\"\n      },\n      {\n   \
      \     \"name\": \"owner\",\n        \"value\": \"xyzgTp@domain.com\"\n     \
      \ },\n      {\n        \"name\": \"namespace\",\n        \"value\": \"openshift-config\"\
      \n      },\n      {\n        \"name\": \"metadata\",\n        \"value\": \"\
      {\\\"certificate_host\\\": \\\"\\\", \\\"service_info\\\": \\\"289****\\\",\
      \ \\\"dn\\\": \\\"\\\\\\\\VED\\\\\\\\Policy\\\\\\\\Aperture\\\\\\\\1CMB-CESD-IT\\\
      \\\\\\AI\\\\\\\\Non-******************************************\\\", \\\"senior_manager_contact\\\
      \": \\\"mDkfg1ufap@domain.com\\\"}\"\n      }\n    ],\n    \"access_points\"\
      : [\n      {\n        \"name\": \"foo\",\n        \"is_public\": \"false\",\n\
      \        \"url\": \"http://foo.com\"\n      },\n      {\n        \"name\": \"\
      bar\",\n        \"is_public\": \"false\",\n        \"url\": \"http://bar.com\"\
      \n      }\n    ]\n  }\n],\n\"dependencies\": [\n  {\n    \"ref\": \"environment:zeta\"\
      ,\n    \"depends_on\": [\n      \"certificate:19641002000006\",\n      \"certificate:19641002000007\"\
      \n    ]\n  }\n]\n}"
  - name: certsToDelete
    required: false
    isInput: false
    isOutput: false
    level: INTERMEDIATE
    type:
      type: object
    value: "{}"
  - name: certIds
    required: false
    isInput: false
    isOutput: false
    level: INTERMEDIATE
    type:
      type: array
    value: "[]"
  - name: accessPoints
    required: false
    isInput: false
    isOutput: false
    level: INTERMEDIATE
    type:
      type: array
    value: "[]"
  - name: accessPointsIds
    required: false
    isInput: false
    isOutput: false
    level: INTERMEDIATE
    type:
      type: array
    value: "[]"
meta:
  workerGroup: default
  layout: flat
  version: 5
finally: null
